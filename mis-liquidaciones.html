<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mis Liquidaciones ‚Äî Portal del Funcionario</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://ocqoipzgtsanpyzjcsis.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcW9pcHpndHNhbnB5empjc2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjEwMDcsImV4cCI6MjA3NjczNzAwN30.mc3mM6ctAyQne5D_Dkw6w9BczzIE9CTe4AQFXqYsMo4';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ‚≠ê Nombres de meses
    const MESES = {
      1: "Enero",
      2: "Febrero",
      3: "Marzo",
      4: "Abril",
      5: "Mayo",
      6: "Junio",
      7: "Julio",
      8: "Agosto",
      9: "Septiembre",
     10: "Octubre",
     11: "Noviembre",
     12: "Diciembre"
    };

    async function loadData() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = "login.html"; return; }

      const email = session.user.email;
      document.getElementById("userEmail").textContent = email;

      const { data, error } = await supabase
        .from("liquidaciones")
        .select("*")
        .eq("email", email)
        .order("anio", { ascending: false })
        .order("mes", { ascending: false });

      const tbody = document.getElementById("tbody");

      if (error || !data?.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="py-4 text-center text-slate-500 text-sm">No hay liquidaciones disponibles.</td>
          </tr>`;
        return;
      }

      tbody.innerHTML = "";

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2">${row.anio}</td>
          <td class="px-4 py-2">${MESES[row.mes] || row.mes}</td>
          <td class="px-4 py-2">${new Date(row.uploaded_at).toLocaleDateString("es-CL")}</td>
          <td class="px-4 py-2 text-right">
            <button class="text-blue-600 underline text-sm">Descargar</button>
          </td>
        `;

        tr.querySelector("button").addEventListener("click", async () => {
          const { data: signed, error: urlError } = await supabase.storage
            .from("liquidaciones")
            .createSignedUrl(row.storage_path, 60);

          if (urlError) {
            alert("No se pudo obtener el archivo. Intenta nuevamente.");
            console.error(urlError);
            return;
          }

          const url = signed.signedUrl;

          // üöÄ POPUP + fallback
          const popup = window.open(url, "_blank");
          if (!popup || popup.closed || typeof popup.closed === "undefined") {
            window.location.href = url;
          }
        });

        tbody.appendChild(tr);
      });
    }

    window.onload = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = "login.html"; return; }

      document.getElementById("userEmail").textContent = session.user.email;

      document.getElementById("logout").onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = "login.html";
      };

      loadData();
    };
  </script>
</head>

<body class="bg-white text-slate-800">

  <header class="border-b">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <img src="Calificaciones.png" class="h-10">
        <span class="font-semibold text-blue-700">Portal del Funcionario</span>
      </a>
      <div class="flex items-center gap-3 text-sm">
        <span id="userEmail" class="px-3 py-1 rounded bg-blue-50 text-blue-700"></span>
        <button id="logout" class="px-3 py-1 rounded bg-blue-600 text-white">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold text-blue-700 mb-6">Mis Liquidaciones</h1>

    <div class="rounded-2xl border overflow-hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-4 py-2 text-left">A√±o</th>
            <th class="px-4 py-2 text-left">Mes</th>
            <th class="px-4 py-2 text-left">Fecha carga</th>
            <th class="px-4 py-2 text-right">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr>
            <td colspan="4" class="px-4 py-4 text-center text-slate-500 text-sm">
              Cargando...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </main>

</body>
</html>
