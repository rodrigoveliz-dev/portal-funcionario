<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador RRHH ‚Äî Portal del Funcionario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --verde:#3cb043; --azul:#004aad; --naranjo:#f57c00; }
    .text-azul{color:var(--azul)} .bg-azul{background-color:var(--azul)}
    .badge{padding:.2rem .5rem;border-radius:.5rem;background:#eef2ff}
    .row:hover{background:#f8fafc}
  </style>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // üöÄ Mismo proyecto que index / carrera / login / mis-liquidaciones
    const SUPABASE_URL = 'https://ocqoipzgtsanpyzjcsis.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcW9pcHpndHNhbnB5empjc2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjEwMDcsImV4cCI6MjA3NjczNzAwN30.mc3mM6ctAyQne5D_Dkw6w9BczzIE9CTe4AQFXqYsMo4';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* Admins que SIEMPRE pueden entrar */
    const SUPER_ADMINS = ['rodrigo.veliz@cormusjm.cl'];

    /* Columnas reales */
    const cols = [
      'email',
      'categoria',
      'tipo_contrato',
      'fecha_inicio_contrato',
      'fecha_ingreso_publico',
      'cap_puntaje_historico',
      'cap_saldo_anterior',
      'cap_puntaje_anual',
      'cap_puntaje_total_periodo',
      'cap_puntaje_computado_anual',
      'cap_balance_final'
    ];

    /* ===========================
       VALIDACI√ìN DE ADMIN SEGURA
       =========================== */
    async function mustBeAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "login.html";
        return null;
      }

      const email = session.user.email.toLowerCase().trim();
      document.getElementById("userEmail").textContent = email;

      if (SUPER_ADMINS.includes(email)) return session.user;

      const { data, error } = await supabase.from("admins").select("email");
      if (error) return session.user; // si falla, dejamos pasar y RLS manda

      const isAdmin = (data || []).some(a => a.email?.toLowerCase().trim() === email);
      if (!isAdmin) {
        document.getElementById("notAdmin").classList.remove("hidden");
        document.getElementById("adminApp").classList.add("hidden");
        return null;
      }
      return session.user;
    }

    function toInput(id) { return document.getElementById(id); }

    function setForm(row) {
      for (const c of cols) {
        const v = row?.[c] ?? "";
        const el = toInput(c);
        if (!el) continue;
        if (el.type === "date") el.value = v ? String(v).slice(0,10) : "";
        else el.value = v;
      }
    }

    /* ===========================
       CARGAR TABLA DE FUNCIONARIOS
       =========================== */
    async function loadTable() {
      const searchValue = document.getElementById("q").value.trim();

      let query = supabase
        .from("funcionarios")
        .select(cols.join(","), { count: "exact" })
        .order("email");

      if (searchValue !== "") {
        query = query.ilike("email", `%${searchValue}%`);
      }

      const { data, error } = await query;
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      if (error) {
        console.error(error);
        return;
      }

      (data || []).forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "row cursor-pointer";
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${r.email}</td>
          <td class="px-3 py-2 text-sm">${r.categoria ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.tipo_contrato ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.fecha_inicio_contrato?.slice(0,10) ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.fecha_ingreso_publico?.slice(0,10) ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_historico ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.cap_saldo_anterior ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_anual ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_total_periodo ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_computado_anual ?? ""}</td>
          <td class="px-3 py-2 text-sm">${r.cap_balance_final ?? ""}</td>
        `;

        tr.addEventListener("click", () => {
          setForm(r);
          document.getElementById("email").readOnly = true;
          document.getElementById("mode").textContent = "Editar funcionario";

          document.getElementById("liqEmail").value = r.email;
          loadLiquidaciones(r.email);
        });

        tbody.appendChild(tr);
      });
    }

    /* GUARDAR FUNCIONARIO */
    async function save() {
      const row = {};
      for (const c of cols) row[c] = toInput(c)?.value || null;

      if (!row.email) return alert("Email obligatorio");

      const numberFields = [
        "cap_puntaje_historico", "cap_saldo_anterior", "cap_puntaje_anual",
        "cap_puntaje_total_periodo", "cap_puntaje_computado_anual", "cap_balance_final"
      ];

      numberFields.forEach(f => row[f] = row[f] ? Number(row[f]) : null);

      const { error } = await supabase.from("funcionarios").upsert(row);
      if (error) {
        alert("Error al guardar: " + error.message);
        return;
      }

      alert("Guardado correctamente");
      clearForm();
      loadTable();
    }

    function clearForm() {
      setForm(null);
      document.getElementById("email").readOnly = false;
      document.getElementById("mode").textContent = "Nuevo funcionario";
    }

    /* ELIMINAR FUNCIONARIO */
    async function deleteFuncionario() {
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Selecciona un funcionario primero.");

      if (!confirm(`Eliminar funcionario ${email}?`)) return;

      const { error } = await supabase.from("funcionarios").delete().eq("email", email);
      if (error) return alert("Error eliminando: " + error.message);

      alert("Eliminado correctamente");
      clearForm();
      loadTable();
    }

    /* ===========================
       LIQUIDACIONES
       =========================== */
    async function loadLiquidaciones(email) {
      const tbody = document.getElementById("liqTbody");
      if (!email) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-xs text-slate-500">Ingresa un correo</td></tr>`;
        return;
      }

      const { data, error } = await supabase
        .from("liquidaciones")
        .select("*")
        .eq("email", email)
        .order("anio", { ascending: false })
        .order("mes", { ascending: false });

      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-600 text-xs">Error cargando</td></tr>`;
        console.error(error);
        return;
      }

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-xs text-slate-500">Sin registros</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      data.forEach(r => {
        const url = `${SUPABASE_URL}/storage/v1/object/public/liquidaciones/${r.storage_path}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${r.anio}</td>
          <td class="px-3 py-2">${r.mes}</td>
          <td class="px-3 py-2 text-xs">${new Date(r.uploaded_at).toLocaleString("es-CL")}</td>
          <td class="px-3 py-2">${r.uploaded_by ?? ""}</td>
          <td class="px-3 py-2 text-right">
            <a href="${url}" target="_blank" class="text-azul underline mr-2 text-xs">Ver</a>
            <button class="text-red-600 text-xs underline">Eliminar</button>
          </td>
        `;

        tr.querySelector("button").addEventListener("click", async () => {
          if (!confirm("¬øEliminar documento?")) return;

          await supabase.storage.from("liquidaciones").remove([r.storage_path]);
          await supabase
            .from("liquidaciones")
            .delete()
            .eq("email", r.email)
            .eq("anio", r.anio)
            .eq("mes", r.mes);

          loadLiquidaciones(email);
        });

        tbody.appendChild(tr);
      });
    }

    async function uploadLiquidacion(adminEmail) {
      const email = document.getElementById("liqEmail").value.trim();
      const anio = Number(document.getElementById("liqAnio").value);
      const mes = Number(document.getElementById("liqMes").value);
      const file = document.getElementById("liqFile").files[0];
      const msg = document.getElementById("liqMsg");

      msg.textContent = "";

      if (!email || !anio || !mes || !file) {
        msg.textContent = "Completa todos los campos.";
        return;
      }

      if (file.type !== "application/pdf") {
        msg.textContent = "Solo se permiten PDF.";
        return;
      }

      const filePath = `${email}/${anio}-${String(mes).padStart(2,"0")}.pdf`;

      const { error: e1 } = await supabase.storage
        .from("liquidaciones")
        .upload(filePath, file, { upsert: true });

      if (e1) {
        msg.textContent = "Error al subir archivo.";
        console.error(e1);
        return;
      }

      const { error: e2 } = await supabase
        .from("liquidaciones")
        .upsert({
          email,
          anio,
          mes,
          storage_path: filePath,
          uploaded_by: adminEmail
        });

      if (e2) {
        msg.textContent = "Error al registrar BD.";
        console.error(e2);
        return;
      }

      msg.textContent = "Subida OK.";
      loadLiquidaciones(email);
    }

    /* Inicializaci√≥n */
    window.addEventListener("DOMContentLoaded", async () => {
      const user = await mustBeAdmin();
      if (!user) return;

      loadTable();

      document.getElementById("q").addEventListener("input", loadTable);
      document.getElementById("save").addEventListener("click", save);
      document.getElementById("new").addEventListener("click", clearForm);
      document.getElementById("delete").addEventListener("click", deleteFuncionario);

      document.getElementById("liqEmail").addEventListener("change", () => {
        const email = document.getElementById("liqEmail").value.trim();
        loadLiquidaciones(email);
      });

      document.getElementById("liqUploadBtn").addEventListener("click", () => {
        uploadLiquidacion(user.email);
      });

      document.getElementById("logout").addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "login.html";
      });
    });
  </script>
</head>

<body class="bg-white text-slate-800">

<header class="border-b">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
    <a href="index.html" class="flex items-center gap-3">
      <img src="Calificaciones.png" alt="Logo" class="h-10 w-auto">
      <span class="font-semibold text-azul">Portal del Funcionario</span>
    </a>
    <div class="flex items-center gap-3 text-sm">
      <span id="userEmail" class="badge"></span>
      <button id="logout" class="px-3 py-1 rounded bg-azul text-white">Cerrar sesi√≥n</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" id="adminApp">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-azul">Administrador RRHH</h1>
    <div class="flex gap-2">
      <input id="q" type="search" placeholder="Buscar por email" class="rounded-xl border px-3 py-2">
      <button id="new" class="px-4 py-2 rounded-xl border">Nuevo</button>
      <button id="save" class="px-4 py-2 rounded-xl bg-azul text-white">Guardar</button>
      <button id="delete" class="px-4 py-2 rounded-xl border border-red-300 text-red-600">Eliminar</button>
    </div>
  </div>

  <div class="grid lg:grid-cols-2 gap-8">

    <!-- Tabla -->
    <section class="rounded-2xl border overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left">Email</th>
            <th class="px-3 py-2 text-left">Cat.</th>
            <th class="px-3 py-2 text-left">Contrato</th>
            <th class="px-3 py-2 text-left">Inicio</th>
            <th class="px-3 py-2 text-left">Ingreso</th>
            <th class="px-3 py-2 text-left">Hist.</th>
            <th class="px-3 py-2 text-left">Saldo ant.</th>
            <th class="px-3 py-2 text-left">Anual</th>
            <th class="px-3 py-2 text-left">Total per√≠odo</th>
            <th class="px-3 py-2 text-left">Computado</th>
            <th class="px-3 py-2 text-left">Balance</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- Formulario -->
    <section class="rounded-2xl border p-6">
      <h2 class="font-semibold mb-2 text-xl"><span id="mode">Nuevo funcionario</span></h2>

      <div class="space-y-3 text-sm">

        <div>
          <label class="text-xs">Email</label>
          <input id="email" type="email" class="mt-1 w-full border rounded px-3 py-2">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Categor√≠a</label>
            <select id="categoria" class="mt-1 w-full border rounded px-3 py-2">
              <option value="">-</option>
              <option value="A">A (Profesional m√©dico)</option>
              <option value="B">B (Otros profesionales)</option>
              <option value="C">C (T√©cnico)</option>
              <option value="D">D (Administrativo)</option>
              <option value="E">E (Auxiliar)</option>
            </select>
          </div>

          <div>
            <label class="text-xs">Tipo contrato</label>
            <select id="tipo_contrato" class="mt-1 w-full border rounded px-3 py-2">
              <option value="">-</option>
              <option value="Indefinido">Indefinido</option>
              <option value="Plazo fijo">Plazo fijo</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Inicio contrato</label>
            <input id="fecha_inicio_contrato" type="date" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Ingreso p√∫blico</label>
            <input id="fecha_ingreso_publico" type="date" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Puntaje hist√≥rico</label>
            <input id="cap_puntaje_historico" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Saldo anterior</label>
            <input id="cap_saldo_anterior" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Puntaje anual</label>
            <input id="cap_puntaje_anual" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Total per√≠odo</label>
            <input id="cap_puntaje_total_periodo" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Computado</label>
            <input id="cap_puntaje_computado_anual" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Balance final</label>
            <input id="cap_balance_final" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

      </div>
    </section>

  </div>

  <!-- Liquidaciones -->
  <section class="mt-10 rounded-2xl border p-6">
    <h2 class="font-semibold text-xl mb-3">Liquidaciones</h2>

    <div class="grid md:grid-cols-3 gap-4 text-sm">
      <div>
        <label class="text-xs">Email</label>
        <input id="liqEmail" type="email" class="mt-1 w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="text-xs">A√±o</label>
        <input id="liqAnio" type="number" class="mt-1 w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="text-xs">Mes</label>
        <select id="liqMes" class="mt-1 w-full border rounded px-3 py-2">
          <option value="">-</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>
    </div>

    <div class="grid md:grid-cols-[1.5fr_1fr] gap-4 items-end mt-3 text-sm">
      <div>
        <label class="text-xs">Archivo PDF</label>
        <input id="liqFile" type="file" class="mt-1 w-full text-xs">
      </div>
      <div class="flex flex-col gap-2">
        <button id="liqUploadBtn" class="px-4 py-2 rounded-xl bg-azul text-white">Subir / Actualizar</button>
        <span id="liqMsg" class="text-xs text-slate-500"></span>
      </div>
    </div>

    <div class="mt-6 border-t pt-4">
      <h3 class="text-xs font-semibold text-slate-600 mb-2">Historial</h3>
      <table class="min-w-full text-sm border rounded-2xl overflow-hidden">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left">A√±o</th>
            <th class="px-3 py-2 text-left">Mes</th>
            <th class="px-3 py-2 text-left">Fecha carga</th>
            <th class="px-3 py-2 text-left">Subida por</th>
            <th class="px-3 py-2 text-right">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="liqTbody">
          <tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 text-xs">Sin datos</td></tr>
        </tbody>
      </table>
    </div>

  </section>

</main>

<section id="notAdmin" class="hidden p-8 text-center">
  <h2 class="text-2xl font-bold text-red-600">Acceso restringido</h2>
  <p class="text-slate-600">Tu cuenta no est√° autorizada.</p>
  <a href="index.html" class="text-azul underline">Volver</a>
</section>

</body>
</html>
