<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador RRHH — Portal del Funcionario</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --verde:#3cb043; --azul:#004aad; --naranjo:#f57c00; }
    .text-azul{color:var(--azul)} .bg-azul{background-color:var(--azul)}
    .badge{padding:.2rem .5rem;border-radius:.5rem;background:#eef2ff}
    .row:hover{background:#f8fafc}
  </style>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://ocqoipzgtsanpyzjcsis.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcW9pcHpndHNhbnB5empjc2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjEwMDcsImV4cCI6MjA3NjczNzAwN30.mc3mM6ctAyQne5D_Dkw6w9BczzIE9CTe4AQFXqYsMo4';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const SUPER_ADMINS = [
      'rodrigo.veliz@cormusjm.cl',
      'jroman@cormusjm.cl',
      'jacqueline@cormusjm.cl'
    ];

    const MESES = {
      1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril',
      5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto',
      9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'
    };

    async function mustBeAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = 'login.html'; return null; }

      const email = session.user.email.toLowerCase().trim();
      document.getElementById('userEmail').textContent = email;

      if (SUPER_ADMINS.includes(email)) return session.user;

      document.getElementById('notAdmin').classList.remove('hidden');
      document.getElementById('adminApp').classList.add('hidden');
      return null;
    }

    const cols = [
      'email','categoria','tipo_contrato','fecha_inicio_contrato',
      'fecha_ingreso_publico','cap_puntaje_historico','cap_saldo_anterior',
      'cap_puntaje_anual','cap_puntaje_total_periodo',
      'cap_puntaje_computado_anual','cap_balance_final'
    ];

    function toInput(id){ return document.getElementById(id); }

    function setForm(row){
      for(const c of cols){
        const el = toInput(c);
        if(!el) continue;
        const v = row?.[c] ?? '';
        if(el.type==='date') el.value = v ? v.slice(0,10):'';
        else el.value = v;
      }
    }

    async function loadTable(){
      const search = document.getElementById('q').value.trim();
      let q = supabase.from('funcionarios').select(cols.join(',')).order('email');
      if(search) q = q.ilike('email',`%${search}%`);

      const { data, error } = await q;
      const tbody=document.getElementById('tbody');
      tbody.innerHTML='';

      if (error) {
        console.error(error);
        tbody.innerHTML = '<tr><td colspan="11" class="px-3 py-3 text-xs text-center text-red-600">Error cargando funcionarios</td></tr>';
        return;
      }

      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.className='row cursor-pointer';
        tr.innerHTML=`
          <td class="px-3 py-2">${r.email}</td>
          <td class="px-3 py-2">${r.categoria??''}</td>
          <td class="px-3 py-2">${r.tipo_contrato??''}</td>
          <td class="px-3 py-2">${r.fecha_inicio_contrato?.slice(0,10)??''}</td>
          <td class="px-3 py-2">${r.fecha_ingreso_publico?.slice(0,10)??''}</td>
          <td class="px-3 py-2">${r.cap_puntaje_historico??''}</td>
          <td class="px-3 py-2">${r.cap_saldo_anterior??''}</td>
          <td class="px-3 py-2">${r.cap_puntaje_anual??''}</td>
          <td class="px-3 py-2">${r.cap_puntaje_total_periodo??''}</td>
          <td class="px-3 py-2">${r.cap_puntaje_computado_anual??''}</td>
          <td class="px-3 py-2">${r.cap_balance_final??''}</td>
        `;
        tr.onclick = () => {
          setForm(r);
          document.getElementById('email').readOnly=true;
          document.getElementById('mode').textContent='Editar funcionario';

          document.getElementById('liqEmail').value = r.email;
          loadLiquidaciones(r.email);
        };
        tbody.appendChild(tr);
      });

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="px-3 py-3 text-xs text-center text-slate-500">Sin funcionarios para mostrar</td></tr>';
      }
    }

    async function save(){
      const row={}; cols.forEach(c=>row[c]=toInput(c)?.value||null);
      if(!row.email) return alert('Email obligatorio');

      const nums=[
        'cap_puntaje_historico','cap_saldo_anterior','cap_puntaje_anual',
        'cap_puntaje_total_periodo','cap_puntaje_computado_anual','cap_balance_final'
      ];
      nums.forEach(n=>row[n]=row[n]?Number(row[n]):null);

      const { error } = await supabase.from('funcionarios').upsert(row);
      if (error) {
        alert('Error al guardar: ' + error.message);
        return;
      }

      alert('Guardado');
      clearForm(); loadTable();
    }

    function clearForm(){
      setForm(null);
      document.getElementById('email').readOnly=false;
      document.getElementById('mode').textContent='Nuevo funcionario';
    }

    async function deleteFuncionario(){
      const email=document.getElementById('email').value.trim();
      if(!email) return alert('Selecciona un funcionario');
      if(!confirm('¿Eliminar?')) return;

      const { error } = await supabase.from('funcionarios').delete().eq('email',email);
      if (error) {
        alert('Error al eliminar: ' + error.message);
        return;
      }

      clearForm(); loadTable();
    }

    async function loadLiquidaciones(email){
      const tbody=document.getElementById('liqTbody');

      if(!email){
        tbody.innerHTML='<tr><td colspan="5" class="py-3 text-xs text-center text-slate-500">Ingresa un correo para ver historial.</td></tr>';
        return;
      }

      const { data, error } = await supabase
        .from('liquidaciones')
        .select('*')
        .eq('email',email)
        .order('anio',{ascending:false})
        .order('mes',{ascending:false});

      if (error) {
        console.error(error);
        tbody.innerHTML = '<tr><td colspan="5" class="py-3 text-xs text-center text-red-600">Error cargando liquidaciones.</td></tr>';
        return;
      }

      if(!data?.length){
        tbody.innerHTML='<tr><td colspan="5" class="py-3 text-xs text-center text-slate-500">Sin registros de liquidaciones.</td></tr>';
        return;
      }

      tbody.innerHTML='';
      data.forEach(r=>{
        const nombreMes = MESES[r.mes] || r.mes;

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="px-3 py-2">${r.anio}</td>
          <td class="px-3 py-2">${nombreMes}</td>
          <td class="px-3 py-2 text-xs">${new Date(r.uploaded_at).toLocaleString('es-CL')}</td>
          <td class="px-3 py-2">${r.uploaded_by ?? ''}</td>
          <td class="px-3 py-2 text-right">
            <button class="text-azul underline mr-2 text-xs ver-btn">Ver</button>
            <button class="text-red-600 text-xs underline eliminar-btn">Eliminar</button>
          </td>
        `;

        const verBtn = tr.querySelector('.ver-btn');
        verBtn.onclick = async () => {
          const { data: signed, error: urlError } = await supabase.storage
            .from('liquidaciones')
            .createSignedUrl(r.storage_path, 60);

          if (urlError) {
            alert('No se pudo generar el enlace del PDF.');
            console.error(urlError);
            return;
          }

          const url = signed.signedUrl;
          const popup = window.open(url, '_blank');
          if (!popup || popup.closed || typeof popup.closed === 'undefined') {
            window.location.href = url;
          }
        };

        const delBtn = tr.querySelector('.eliminar-btn');
        delBtn.onclick = async () => {
          if (!confirm('¿Eliminar este PDF y su registro?')) return;

          await supabase.storage.from('liquidaciones').remove([r.storage_path]);
          await supabase
            .from('liquidaciones')
            .delete()
            .eq('email', r.email)
            .eq('anio', r.anio)
            .eq('mes', r.mes);

          loadLiquidaciones(email);
        };

        tbody.appendChild(tr);
      });
    }

    async function uploadLiquidacion(adminEmail){
      const email=document.getElementById('liqEmail').value.trim();
      const anio=Number(document.getElementById('liqAnio').value);
      const mes=Number(document.getElementById('liqMes').value);
      const file=document.getElementById('liqFile').files[0];
      const msg=document.getElementById('liqMsg');
      msg.textContent='';

      if(!email||!anio||!mes||!file){
        msg.textContent='Completa email, año, mes y archivo PDF.';
        return;
      }
      if(file.type!=='application/pdf'){
        msg.textContent='Solo se permiten archivos PDF.';
        return;
      }

      const filePath = `${email}/${anio}/${String(mes).padStart(2,'0')}.pdf`;

      console.log('Subiendo a storage path:', filePath);

      const { error: e1 } = await supabase
        .storage.from('liquidaciones')
        .upload(filePath, file, {
          upsert: true,
          contentType: 'application/pdf'
        });

      if (e1) {
        console.error('Error al subir al storage:', e1);
        msg.textContent = `Error al subir archivo: ${e1.message || 'Error desconocido'}`;
        return;
      }

      const { error: e2 } = await supabase
        .from('liquidaciones')
        .upsert({
          email,
          anio,
          mes,
          storage_path: filePath,
          uploaded_by: adminEmail
        });

      if (e2) {
        console.error('Error al registrar en BD:', e2);
        msg.textContent = `Error al registrar en BD: ${e2.message || 'Error desconocido'}`;
        return;
      }

      msg.textContent='Liquidación subida correctamente.';
      loadLiquidaciones(email);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      const user = await mustBeAdmin();
      if (!user) return;

      loadTable();

      document.getElementById('q').oninput = loadTable;
      document.getElementById('save').onclick = save;
      document.getElementById('new').onclick = clearForm;
      document.getElementById('delete').onclick = deleteFuncionario;

      document.getElementById('liqEmail').onchange = () => {
        loadLiquidaciones(document.getElementById('liqEmail').value.trim());
      };
      document.getElementById('liqUploadBtn').onclick = () => {
        uploadLiquidacion(user.email);
      };

      document.getElementById('logout').onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      };
    });
  </script>
</head>

<body class="bg-white text-slate-800">

<header class="border-b">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
    <a href="index.html" class="flex items-center gap-3">
      <img src="Calificaciones.png" alt="Logo" class="h-10 w-auto">
      <span class="font-semibold text-azul">Portal del Funcionario</span>
    </a>
    <div class="flex items-center gap-3 text-sm">
      <span id="userEmail" class="badge"></span>
      <button id="logout" class="px-3 py-1 rounded bg-azul text-white">Cerrar sesión</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" id="adminApp">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-azul">Administrador RRHH</h1>
    <div class="flex gap-2">
      <input id="q" type="search" placeholder="Buscar por email" class="rounded-xl border px-3 py-2">
      <button id="new" class="px-4 py-2 rounded-xl border">Nuevo</button>
      <button id="save" class="px-4 py-2 rounded-xl bg-azul text-white">Guardar</button>
      <button id="delete" class="px-4 py-2 rounded-xl border border-red-300 text-red-600">Eliminar</button>
    </div>
  </div>

  <div class="grid lg:grid-cols-2 gap-8">

    <section class="rounded-2xl border overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left">Email</th>
            <th class="px-3 py-2 text-left">Cat.</th>
            <th class="px-3 py-2 text-left">Contrato</th>
            <th class="px-3 py-2 text-left">Inicio</th>
            <th class="px-3 py-2 text-left">Ingreso</th>
            <th class="px-3 py-2 text-left">Hist.</th>
            <th class="px-3 py-2 text-left">Saldo ant.</th>
            <th class="px-3 py-2 text-left">Anual</th>
            <th class="px-3 py-2 text-left">Total período</th>
            <th class="px-3 py-2 text-left">Computado</th>
            <th class="px-3 py-2 text-left">Balance</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section class="rounded-2xl border p-6">
      <h2 class="font-semibold mb-2 text-xl"><span id="mode">Nuevo funcionario</span></h2>

      <div class="space-y-3 text-sm">
        <div>
          <label class="text-xs">Email</label>
          <input id="email" type="email" class="mt-1 w-full border rounded px-3 py-2">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Categoría</label>
            <select id="categoria" class="mt-1 w-full border rounded px-3 py-2">
              <option value="">-</option>
              <option value="A">A (Médico)</option>
              <option value="B">B (Otros prof.)</option>
              <option value="C">C (Técnico)</option>
              <option value="D">D (Administrativo)</option>
              <option value="E">E (Auxiliar)</option>
            </select>
          </div>
          <div>
            <label class="text-xs">Tipo contrato</label>
            <select id="tipo_contrato" class="mt-1 w-full border rounded px-3 py-2">
              <option value="">-</option>
              <option value="Indefinido">Indefinido</option>
              <option value="Plazo fijo">Plazo fijo</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Inicio contrato</label>
            <input id="fecha_inicio_contrato" type="date" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Ingreso público</label>
            <input id="fecha_ingreso_publico" type="date" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Puntaje histórico</label>
            <input id="cap_puntaje_historico" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Saldo anterior</label>
            <input id="cap_saldo_anterior" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Puntaje anual</label>
            <input id="cap_puntaje_anual" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Total período</label>
            <input id="cap_puntaje_total_periodo" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs">Computado</label>
            <input id="cap_puntaje_computado_anual" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-xs">Balance final</label>
            <input id="cap_balance_final" type="number" class="mt-1 w-full border rounded px-3 py-2">
          </div>
        </div>
      </div>
    </section>

  </div>

  <section class="mt-10 rounded-2xl border p-6">
    <h2 class="font-semibold text-xl mb-3">Liquidaciones</h2>

    <div class="grid md:grid-cols-3 gap-4 text-sm">
      <div>
        <label class="text-xs">Email</label>
        <input id="liqEmail" type="email" class="mt-1 w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="text-xs">Año</label>
        <input id="liqAnio" type="number" class="mt-1 w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="text-xs">Mes</label>
        <select id="liqMes" class="mt-1 w-full border rounded px-3 py-2">
          <option value="">-</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>
    </div>

    <div class="grid md:grid-cols-[1.5fr_1fr] gap-4 items-end mt-3 text-sm">
      <div>
        <label class="text-xs">Archivo PDF</label>
        <input id="liqFile" type="file" class="mt-1 w-full text-xs">
      </div>
      <div class="flex flex-col gap-2">
        <button id="liqUploadBtn" class="px-4 py-2 rounded-xl bg-azul text-white">Subir / Actualizar</button>
        <span id="liqMsg" class="text-xs text-slate-500"></span>
      </div>
    </div>

    <div class="mt-6 border-t pt-4">
      <h3 class="text-xs font-semibold text-slate-600 mb-2">Historial</h3>
      <table class="min-w-full text-sm border rounded-2xl overflow-hidden">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left">Año</th>
            <th class="px-3 py-2 text-left">Mes</th>
            <th class="px-3 py-2 text-left">Fecha carga</th>
            <th class="px-3 py-2 text-left">Subida por</th>
            <th class="px-3 py-2 text-right">Acción</th>
          </tr>
        </thead>
        <tbody id="liqTbody">
          <tr>
            <td colspan="5" class="px-3 py-3 text-center text-slate-500 text-xs">Sin datos</td>
          </tr>
        </tbody>
      </table>
    </div>

  </section>

</main>

<section id="notAdmin" class="hidden p-8 text-center">
  <h2 class="text-2xl font-bold text-red-600">Acceso restringido</h2>
  <p class="text-slate-600">Tu cuenta no está autorizada para acceder a este módulo.</p>
  <a href="index.html" class="text-azul underline">Volver al inicio</a>
</section>

</body>
</html>
