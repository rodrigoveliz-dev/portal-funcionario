<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador RRHH — Portal del Funcionario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --verde:#3cb043; --azul:#004aad; --naranjo:#f57c00; }
    .text-azul{color:var(--azul)} .bg-azul{background-color:var(--azul)} .badge{padding:.2rem .5rem;border-radius:.5rem;background:#eef2ff}
    .row:hover{background:#f8fafc}
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const SUPABASE_URL = 'https://ocqoipzgtsanpyzjcsis.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcW9pcHpndHNhbnB5empjc2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjEwMDcsImV4cCI6MjA3NjczNzAwN30.mc3mM6ctAyQne5D_Dkw6w9BczzIE9CTe4AQFXqYsMo4';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // SUPER ADMINS que siempre pueden entrar
    const SUPER_ADMINS = [
      'rodrigo.veliz@cormusjm.cl'
    ];

    // Columnas REALES de tu tabla "funcionarios"
    const cols = [
      'email',
      'categoria',
      'tipo_contrato',
      'fecha_inicio_contrato',
      'fecha_ingreso_publico',
      'cap_puntaje_historico',
      'cap_saldo_anterior',
      'cap_puntaje_anual',
      'cap_puntaje_total_periodo',
      'cap_puntaje_computado_anual',
      'cap_balance_final'
    ];

    async function mustBeAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return null;
      }

      const email = session.user.email.toLowerCase().trim();
      document.getElementById('userEmail').textContent = email;

      // 1) Si es SUPER_ADMIN, pasa directo
      if (SUPER_ADMINS.includes(email)) {
        return session.user;
      }

      // 2) Validar contra la tabla admins
      const { data, error } = await supabase
        .from('admins')
        .select('email');

      if (error) {
        document.getElementById('err').textContent = 'Error validando rol: ' + error.message;
        console.error(error);
        document.getElementById('notAdmin').classList.remove('hidden');
        document.getElementById('adminApp').classList.add('hidden');
        return null;
      }

      const isAdmin = (data || []).some(a =>
        a.email && a.email.toLowerCase().trim() === email
      );

      if (!isAdmin) {
        document.getElementById('notAdmin').classList.remove('hidden');
        document.getElementById('adminApp').classList.add('hidden');
        return null;
      }

      return session.user;
    }

    function toInput(id) { return document.getElementById(id); }

    function setForm(row) {
      for (const c of cols) {
        const v = row?.[c] ?? '';
        const i = toInput(c); if (!i) continue;
        if (i.type === 'date') {
          i.value = v ? String(v).slice(0, 10) : '';
        } else {
          i.value = v;
        }
      }
    }

    async function loadTable() {
      const q = document.getElementById('q').value.trim();
      let query = supabase
        .from('funcionarios')
        .select(cols.join(','), { count: 'exact' })
        .order('email');

      if (q) query = query.ilike('email', `%${q}%`);

      const { data, error } = await query;
      const tbody = document.getElementById('tbody'); 
      tbody.innerHTML = '';

      if (error) {
        document.getElementById('err').textContent = error.message;
        console.error(error);
        return;
      }

      for (const r of (data || [])) {
        const tr = document.createElement('tr'); 
        tr.className = 'row cursor-pointer';
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${r.email || ''}</td>
          <td class="px-3 py-2 text-sm">${r.categoria || ''}</td>
          <td class="px-3 py-2 text-sm">${r.tipo_contrato || ''}</td>
          <td class="px-3 py-2 text-sm">${(r.fecha_inicio_contrato || '').slice(0,10)}</td>
          <td class="px-3 py-2 text-sm">${(r.fecha_ingreso_publico || '').slice(0,10)}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_historico ?? ''}</td>
          <td class="px-3 py-2 text-sm">${r.cap_saldo_anterior ?? ''}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_anual ?? ''}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_total_periodo ?? ''}</td>
          <td class="px-3 py-2 text-sm">${r.cap_puntaje_computado_anual ?? ''}</td>
          <td class="px-3 py-2 text-sm">${r.cap_balance_final ?? ''}</td>
        `;
        tr.addEventListener('click', () => {
          setForm(r);
          document.getElementById('email').readOnly = true;
          document.getElementById('mode').textContent = 'Editar funcionario';
        });
        tbody.appendChild(tr);
      }
    }

    async function save() {
      const row = {};
      for (const c of cols) {
        row[c] = toInput(c)?.value || null;
      }
      if (!row.email) {
        alert('Email es obligatorio');
        return;
      }

      // Campos numéricos
      for (const n of [
        'cap_puntaje_historico',
        'cap_saldo_anterior',
        'cap_puntaje_anual',
        'cap_puntaje_total_periodo',
        'cap_puntaje_computado_anual',
        'cap_balance_final'
      ]) {
        if (row[n] !== null && row[n] !== '') {
          row[n] = Number(row[n]);
        } else {
          row[n] = null;
        }
      }

      const { error } = await supabase.from('funcionarios').upsert(row).select();
      if (error) {
        alert('Error al guardar: ' + error.message);
        console.error(error);
        return;
      }
      await loadTable();
      alert('Guardado');
      clearForm();
    }

    function clearForm() {
      setForm(null);
      document.getElementById('email').readOnly = false;
      document.getElementById('mode').textContent = 'Nuevo funcionario';
    }

    // ===== LIQUIDACIONES =====
    async function loadLiquidaciones(email) {
      const tbody = document.getElementById('liqTbody');
      const msg = document.getElementById('liqMsg');
      if (!tbody) return;

      if (!email) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 text-xs">Ingresa un email para ver el historial.</td></tr>`;
        return;
      }

      tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 text-xs">Cargando…</td></tr>`;
      msg.textContent = '';

      const { data, error } = await supabase
        .from('liquidaciones')
        .select('anio, mes, storage_path, uploaded_at, uploaded_by')
        .eq('email', email)
        .order('anio', { ascending:false })
        .order('mes', { ascending:false });

      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-3 text-center text-red-600 text-xs">Error al cargar liquidaciones.</td></tr>`;
        console.error(error);
        return;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 text-xs">No hay liquidaciones registradas para este funcionario.</td></tr>`;
        return;
      }

      const meses = ["","Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

      tbody.innerHTML = '';
      for (const row of data) {
        const tr = document.createElement('tr');
        tr.className = 'border-t';

        const fecha = row.uploaded_at ? new Date(row.uploaded_at).toLocaleDateString('es-CL') : '';

        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${row.anio}</td>
          <td class="px-3 py-2 text-sm">${meses[row.mes] || row.mes}</td>
          <td class="px-3 py-2 text-sm">${fecha}</td>
          <td class="px-3 py-2 text-xs">${row.uploaded_by || ''}</td>
          <td class="px-3 py-2 text-right">
            <button class="px-3 py-1 rounded-full border text-xs">Ver PDF</button>
          </td>
        `;

        const btn = tr.querySelector('button');
        btn.addEventListener('click', async () => {
          const { data: signed, error: urlError } = await supabase.storage
            .from('liquidaciones')
            .createSignedUrl(row.storage_path, 60);

          if (urlError) {
            alert('No se pudo generar el enlace del PDF.');
            console.error(urlError);
            return;
          }
          window.open(signed.signedUrl, '_blank');
        });

        tbody.appendChild(tr);
      }
    }

   async function uploadLiquidacion(adminEmail) {
  const emailInput = document.getElementById('liqEmail');
  const anioInput  = document.getElementById('liqAnio');
  const mesSelect  = document.getElementById('liqMes');
  const fileInput  = document.getElementById('liqFile');
  const msg        = document.getElementById('liqMsg');

  const email = (emailInput?.value || '').trim();
  const anio  = Number(anioInput?.value || '');
  const mes   = Number(mesSelect?.value || '');
  const file  = fileInput?.files?.[0];

  msg.textContent = '';

  if (!email) {
    msg.textContent = 'Debes ingresar el email del funcionario.';
    return;
  }
  if (!anio || !mes) {
    msg.textContent = 'Debes indicar año y mes.';
    return;
  }
  if (!file) {
    msg.textContent = 'Selecciona un archivo PDF.';
    return;
  }

  const mesStr = String(mes).padStart(2,'0');
  const path = `${email}/${anio}/${mesStr}.pdf`;

  msg.textContent = 'Subiendo archivo al storage…';

  const { error: uploadError } = await supabase.storage
    .from('liquidaciones')
    .upload(path, file, { upsert:true });

  if (uploadError) {
    console.error('UPLOAD ERROR', uploadError);
    msg.textContent = 'Error al subir archivo al storage: ' + (uploadError.message || '');
    return;
  }

  msg.textContent = 'Registrando liquidación en la base de datos…';

  const { error: upsertError } = await supabase
    .from('liquidaciones')
    .upsert({
      email,
      anio,
      mes,
      storage_path: path,
      uploaded_by: adminEmail || null
    }, {
      onConflict: 'email,anio,mes'
    });

  if (upsertError) {
    console.error('UPSERT ERROR', upsertError);
    msg.textContent = 'Error al registrar liquidación en la base de datos: ' + (upsertError.message || '');
    return;
  }

  msg.textContent = 'Liquidación subida/actualizada correctamente.';
  fileInput.value = '';

  await loadLiquidaciones(email);
}

    window.addEventListener('DOMContentLoaded', async () => {
      const user = await mustBeAdmin();
      if (!user) return;

      await loadTable();

      document.getElementById('q').addEventListener('input', () => loadTable());
      document.getElementById('save').addEventListener('click', save);
      document.getElementById('new').addEventListener('click', clearForm);
      document.getElementById('logout').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      const liqEmailInput = document.getElementById('liqEmail');
      const liqUploadBtn  = document.getElementById('liqUploadBtn');

      if (liqEmailInput) {
        liqEmailInput.addEventListener('change', () => {
          const email = liqEmailInput.value.trim();
          loadLiquidaciones(email);
        });
      }

      if (liqUploadBtn) {
        liqUploadBtn.addEventListener('click', () => {
          uploadLiquidacion(user.email);
        });
      }
    });
  </script>
</head>
<body class="bg-white text-slate-800">
  <header class="border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <img src="Calificaciones.png" alt="Logo" class="h-10 w-auto"/>
        <span class="font-semibold text-azul">Portal del Funcionario</span>
      </a>
      <div class="flex items-center gap-3 text-sm">
        <span id="userEmail" class="badge"></span>
        <button id="logout" class="px-3 py-1 rounded bg-azul text-white">Cerrar sesión</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" id="adminApp">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-azul">Administrador RRHH</h1>
      <div class="flex gap-2">
        <input id="q" type="search" placeholder="Buscar por email" class="rounded-xl border-slate-300 focus:border-azul focus:ring-azul px-3 py-2" />
        <button id="new" class="px-4 py-2 rounded-xl border">Nuevo</button>
        <button id="save" class="px-4 py-2 rounded-xl bg-azul text-white">Guardar</button>
      </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Tabla funcionarios -->
      <section class="rounded-2xl border overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-3 py-2 text-left">Email</th>
              <th class="px-3 py-2 text-left">Cat.</th>
              <th class="px-3 py-2 text-left">Tipo contrato</th>
              <th class="px-3 py-2 text-left">Inicio contrato</th>
              <th class="px-3 py-2 text-left">Ingreso público</th>
              <th class="px-3 py-2 text-left">CAP hist.</th>
              <th class="px-3 py-2 text-left">CAP saldo ant.</th>
              <th class="px-3 py-2 text-left">CAP anual</th>
              <th class="px-3 py-2 text-left">CAP total periodo</th>
              <th class="px-3 py-2 text-left">CAP computado anual</th>
              <th class="px-3 py-2 text-left">CAP balance final</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>

      <!-- Formulario funcionario -->
      <section class="rounded-2xl border p-6">
        <h2 id="mode" class="text-xl font-semibold mb-4">Nuevo funcionario</h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm">Email</label>
            <input id="email" type="email" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" placeholder="usuario@cormusjm.cl" />
          </div>
          <div>
            <label class="block text-sm">Categoría</label>
            <select id="categoria" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul">
              <option value="">—</option>
              <option value="A">A (Prof. médico)</option>
              <option value="B">B (Prof. no médico)</option>
              <option value="C">C (Técnico)</option>
              <option value="D">D (Auxiliar Paramédico)</option>
              <option value="E">E (Administrativo)</option>
              <option value="F">F (Auxiliar/Conductor)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm">Tipo de contrato</label>
            <input id="tipo_contrato" type="text" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" placeholder="Indefinido / Plazo fijo" />
          </div>
          <div>
            <label class="block text-sm">Inicio contrato vigente</label>
            <input id="fecha_inicio_contrato" type="date" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">Ingreso funcionario público</label>
            <input id="fecha_ingreso_publico" type="date" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">CAP puntaje histórico</label>
            <input id="cap_puntaje_historico" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">CAP saldo anterior</label>
            <input id="cap_saldo_anterior" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">CAP puntaje anual</label>
            <input id="cap_puntaje_anual" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">CAP puntaje total período</label>
            <input id="cap_puntaje_total_periodo" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">CAP puntaje computado anual</label>
            <input id="cap_puntaje_computado_anual" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
          <div>
            <label class="block text-sm">CAP balance final</label>
            <input id="cap_balance_final" type="number" step="0.01" class="w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
          </div>
        </div>
      </section>
    </div>

    <!-- Gestión de liquidaciones -->
    <section class="rounded-2xl border p-6 lg:col-span-2 mt-8">
      <h2 class="text-xl font-semibold mb-4 text-azul">Gestión de liquidaciones de sueldo</h2>
      <p class="text-sm text-slate-600 mb-4">
        Sube o actualiza las liquidaciones de sueldo de los funcionarios. La búsqueda se realiza por correo institucional.
      </p>

      <div class="grid sm:grid-cols-4 gap-4 items-end">
        <div class="sm:col-span-2">
          <label class="block text-sm">Email funcionario</label>
          <input id="liqEmail" type="email" placeholder="usuario@cormusjm.cl"
                 class="mt-1 w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
        </div>
        <div>
          <label class="block text-sm">Año</label>
          <input id="liqAnio" type="number" min="2000" max="2100"
                 class="mt-1 w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul" />
        </div>
        <div>
          <label class="block text-sm">Mes</label>
          <select id="liqMes" class="mt-1 w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul">
            <option value="">—</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
      </div>

      <div class="grid sm:grid-cols-4 gap-4 items-end mt-4">
        <div class="sm:col-span-2">
          <label class="block text-sm">Archivo PDF de liquidación</label>
          <input id="liqFile" type="file" accept="application/pdf"
                 class="mt-1 w-full rounded-xl border-slate-300 focus:border-azul focus:ring-azul bg-white" />
        </div>
        <div>
          <button id="liqUploadBtn"
                  class="w-full mt-1 px-4 py-2 rounded-xl bg-azul text-white text-sm font-semibold hover:bg-blue-800">
            Subir / Actualizar liquidación
          </button>
        </div>
      </div>

      <div id="liqMsg" class="mt-3 text-sm text-slate-600"></div>

      <div class="mt-6">
        <h3 class="text-sm font-semibold mb-2">Historial del funcionario</h3>
        <table class="min-w-full text-sm border rounded-2xl overflow-hidden">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-3 py-2 text-left">Año</th>
              <th class="px-3 py-2 text-left">Mes</th>
              <th class="px-3 py-2 text-left">Fecha carga</th>
              <th class="px-3 py-2 text-left">Subida por</th>
              <th class="px-3 py-2 text-right">Acción</th>
            </tr>
          </thead>
          <tbody id="liqTbody">
            <tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 text-xs">Sin datos</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <div id="err" class="text-red-600 mt-6"></div>
  </main>

  <section id="notAdmin" class="hidden max-w-2xl mx-auto p-8 text-center">
    <h2 class="text-2xl font-bold text-red-600">Acceso restringido</h2>
    <p class="mt-2 text-slate-600">Tu cuenta no está autorizada como administrador. Solicita acceso a RRHH.</p>
    <a href="index.html" class="mt-4 inline-block text-azul hover:underline">Volver al portal</a>
  </section>

  <footer class="border-t">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-sm text-slate-600">
      © <span id="year"></span> Corporación Municipal San José de Maipo
    </div>
  </footer>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>

